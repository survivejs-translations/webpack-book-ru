# Встряхивание дерева

**Встряхивание дерева (tree shaking)** - это свойство (???функция), которое включено в определение модулей стандарта ES2015. Идея состоит в том, что при условии, что можно проанализировать определение модуля статически, не выполняя его, webpack может сказать какие части кода будут использованы, а какие - нет. Это можно проверить, расширив наше приложение и добавив там код, который необходимо убрать.

T> В определенной степени, встряхивание дерева работает через [webpack-common-shake](https://www.npmjs.com/package/webpack-common-shake) используя определение модулей CommonJS. Использование данного плагина имеет значение, поскольку большинство пакетов npm были созданы с использованием более старого определения.

## Демонстрация встряхивания дерева

Чтобы "встряхнуть" ваш код, вам необходимо определить модуль, и использовать только часть его кода. Итак, давайте создадим такой модуль:

**src/shake.js**

```javascript
const shake = () => console.log("shake");
const bake = () => console.log("bake");

export { shake, bake };
```

{pagebreak}

А теперь изменим точку входа нашего приложения, чтобы убедится что мы используем только часть кода:

**src/index.js**

```javascript
...
import { bake } from "./shake";

bake();

...
```

Если вы соберете проект с помощью (`npm run build`) и проанализируете код сборки (*dist/main.js*), то он должен содержать `console.log("bake")`, но код `console.log("shake")` должен отсуствовать. Это и есть встряхивание дерева в действии.

Чтобы лучше понять, какие именно части модулей будут включены webpack, запустите сборку со следующим флагом: `npm run build -- --display-used-exports`. В терминале webpack вам должен вывести `[no exports used]` или `[only some exports used: bake]`.

T> Если вы используете `UglifyJsPlugin`, для аналогичного эффекта включите предупреждения. В дополнение к другим сообщениям вы увидите сообщения, вроде `Dropping unused variable treeShakingDemo [./src/component.js:17,6]`.

T> Существует реализация встряски дерева, основанная на "проверке концепции" для CSS модулей - [dead-css-loader](https://github.com/simlrh/dead-css-loader).

## Встряхивание дерева на уровне пакетов

Такой подход работает в том числе с зависимостями, которые используют определение модулей стандарта ES2015. Поскольку стандарты создания пакетов все еще появляются, вы должны быть осторожны при использовании таких пакетов. Именно по этой причине webpack пытается разрешить поле `module` в *package.json*.

Чтобы позволить таким инструментам как webpack выполнить встряхивание npm пакетов, вам следует сгенерировать сборку таким образом, что все, кроме определений модулей ES2015, будет транспилировано, а затем сослаться на готовый модуль в поле `module` файла *package.json*. Для этого, вам необходимо позволить webpack управлять модулями ES2015 установив флаг `"modules": false` в настройках Babel.

Чтобы получить максимальную выгоду от встряски дерева на уровне пакетов, вам необходимо использовать [babel-plugin-transform-imports](https://www.npmjs.com/package/babel-plugin-transform-imports), чтобы преобразовать импорты к такому виду, с которым работает логика встряски webpack. За дополнительной информацией, обратитесь к [webpack issue #2867](https://github.com/webpack/webpack/issues/2867).

T> Руководство [SurviveJS - Maintenance](https://survivejs.com/maintenance/packaging/building/) более подробно описывает то, каким образом следует разрабатывать пакеты, чтобы к ним можно было применить встряску дерева.

## Резюме

Встряхивание дерева - это потенциально мощная техника. Для получения максимальной выгоды от встряски, пакеты npm должны быть написаны с использованием синтаксиса модулей ES2015, и они должны ссылаться на такую форму объявления модулей ES2015 через поле `module` в файле *package.json* чтобы такие инструменты как webpack могли найти эти объявления.

В итоге:

* **Встряхивание дерева** удаляет неиспользуемые куски кода, основываясь на статическом анализе исходного кода. Webpack выполняет этот процесс во время построения графа зависимостей.
* Для того чтобы получить выгоду от использования данной техники, вам нужно использовать определения модулей стандарта ES2015.
* Как автор пакета, вы можете предоставить такую версию вашего пакета, которая содержит модули ES2015, в то время как все остальное может быть транспилировано к ES5.

В следующей главе, вы научитесь управлять переменными окружения с помощью webpack.
